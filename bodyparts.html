<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        img {
            max-width: 300px;
        }

        output {
            display: block;
            white-space: pre;
        }

        #ben {
            display: none;
        }

        #canvasholder {
            /* background-image: url(ben.jpg); */
            background-size: cover;
            width: 640px;
            height: 480px;
            position: relative;
        }

        #canvasholder canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <img src="ben.jpg" id="ben" />

    <div id="canvasholder"><canvas></canvas></div>

    <output></output>

    <script src="https://unpkg.com/@tensorflow/tfjs"></script>
    <script src="https://unpkg.com/@tensorflow-models/posenet">
    </script>
    <script type="module">
        import { getDemoPose, getPoseFromImage, PoseStream } from './poses.js';
        const canvas = document.querySelector("#canvasholder canvas");
        const ctx = canvas.getContext('2d');

        // Takes an (x,y) point
        function scalePoint(point) {
            const widthOriginal = 1616;
            const heightOriginal = 1077;

            const widthTarget = 640;
            const heightTarget = 480;

            const widthScale = (1 / widthOriginal) * widthTarget;
            const heightScale = (1 / heightOriginal) * heightTarget;

            return {
                x: point.x * widthScale,
                y: point.y * heightScale
            };
        }

        function tidiedPoseData(pose) {
            const usedParts = [
                "rightShoulder", "rightElbow", "rightWrist",
                "leftShoulder", "leftElbow", "leftWrist"
            ];
            const filteredParts = pose.keypoints.filter((point) => {
                delete point.score; // don't need this
                return usedParts.includes(point.part);
            })

            // console.log(filteredParts);


            return filteredParts;
        }

        function poseAsLimbs(pose) {
            /*
                Actual order that we get is:

                leftShoulder, rightShoulder, leftElbow, rightElbow, leftWrist, rightWrist

            */

            const limbs = {
                leftBicep: [scalePoint(pose[0].position), scalePoint(pose[2].position)],
                leftForearm: [scalePoint(pose[2].position), scalePoint(pose[4].position)],
                // leftHand: [pose[4].position],

                rightBicep: [scalePoint(pose[1].position), scalePoint(pose[3].position)],
                rightForearm: [scalePoint(pose[3].position), scalePoint(pose[5].position)]
                // rightHand: [pose[5].position]
            };

            return limbs;
        }
        // Imagine how often you'll typo drawLimb as drawLine
        function drawLimb(from, to) {
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();
        }

        function drawPose(pose) {
            ctx.fillStyle = "#f00";

            // do some points
            pose.forEach((part) => {
                const pos = scalePoint(part.position);
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 2, 0, Math.PI * 2, true);
                ctx.fill();
            });

            console.log(poseAsLimbs(pose));

            Object.values(poseAsLimbs(pose)).forEach((limb) => {

                drawLimb(limb[0], limb[1]);
            })

            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // document.querySelector('output').innerHTML = JSON.stringify(getDemoPose(), null, 2)

        // getPoseFromImage(document.getElementById('ben'))
        //     .then(pose => {
        //         document.querySelector('output').innerHTML = JSON.stringify(pose, null, 2)

        //         drawPose(tidiedPoseData(pose))
        //     })

        const stream = new PoseStream();
        stream.start()

        stream.addEventListener('pose', (event) => {

            drawPose(tidiedPoseData(event.data))

        })
    </script>



</body>

</html>